<!doctype html> 
<!-- Copyright (C) 2018 Alkis Georgopoulos <alkisg@gmail.com>. License: GPLv3. -->
<html lang="el"> 
<head> 
  <meta charset="UTF-8" />
  <!-- Using this metatag users can't scale the page using pinchIn/out gestures on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>Ανάμιξη χρωμάτων</title> 
  <script src="https://code.createjs.com/1.0.0/easeljs.min.js"></script>
  <style type="text/css">
    /* Remove margins and HTML scrollbars */
    body, html  {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: black;
    }
    #mainCanvas {
    padding: 0;
    margin: auto;
    display: block;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    }
  </style>
</head>
<body onload = "init();">
  <canvas id="mainCanvas" width="320" height="180">
    Your browser doesn't support HTML5!
  </canvas>
<script>
  var stage;
  var statusText = "";
  var resourceNames = ["background.svg","bar_home.svg", "bar_help.svg", "bar_about.svg", "bar_previous.svg", "bar_next.svg","buttonOK.svg",
      "redPlus.svg", "redMinus.svg", "yellowPlus.svg", "yellowMinus.svg", "bluePlus.svg", "blueMinus.svg", "popup.svg", "lion_good.svg", ];
  var resourcesLoaded = 0;
  var resources = [];
  var ratio = 13/9;
  var winratio;
  var boxl;
  var boxr;
  var menubar = [];
  var lvlText = "1";
  var level = 0; 
  var bg;
  var buttonOk;
  var radius;
  var explainText;
  //Level config
  var colorStep = [100,100,100,100,100,50,50,25,25, 12.5, 12.5, 12.5  ];
  var colorNum  = [  1,  2,  3,  3,  3, 2, 3, 2, 3, 2   ,    3,    3  ];  
  var lvlColorStep;
  var lvlColorNum;
  var targetrybs = {};
  var workingrybs = {'R':0,'Y':0,'B':0};
  var workingCircle = new createjs.Shape();
  var targetCircle = new createjs.Shape();
  var ci;
  var popupCont;
  var popupBkg;
  var popupTxt;
  var pu;
  var targetColors = [];
  var imgSuccess;
  var success;
  var redPlus;
  var redMinus;
  var yellowPlus;
  var yellowMinus;
  var bluePlus;
  var blueMinus;

  function popup(){
    this.setTxt = popupSetTxt;
    this.show = popupShow;
    this.hide = popupHide;
    this.resize = popupResize;
    //this.resize = popupResize;
  }
  function popupHide(){
    popupBkg.visible = false;
    popupTxt.visible = false;
    stage.update();
  }
  function popupSetTxt(txt){
    this.txt = txt;
  }

  function popupResize(){
    popupTxt.font = parseInt(stage.canvas.height/30) + "px Arial";
    popupTxt.x = 34/1280*stage.canvas.width;
    popupTxt.y = 86/720*stage.canvas.height;
    popupCont.x = 280/1280*stage.canvas.width;
    popupCont.y = 210/720*stage.canvas.height;
    popupBkg.scaleX = stage.canvas.width/1280;
    popupBkg.scaleY = stage.canvas.height/720;
    var h = new createjs.Shape();
    h.graphics.beginFill('#000').drawRect(650/720*popupBkg.image.width,0,90/720*popupBkg.image.width,80/260*popupBkg.image.height);
    popupBkg.hitArea = h;
    popupCont.width = popupBkg.width;
    popupCont.height = popupBkg.height;   
    stage.setChildIndex(popupCont,stage.numChildren-1);
  }

  function popupShow(){
    this.resize();
    popupTxt.text = this.txt;
    popupBkg.addEventListener('click',function(e){
      pu.hide();
      });
    popupBkg.visible = true;
    popupTxt.visible = true;
    popupCont.addChild(popupBkg);
    popupCont.addChild(popupTxt);
    stage.addChild(popupCont);
    stage.setChildIndex(popupCont,stage.numChildren-1);
    stage.update();
  }



  function init(){
    console.clear();
    stage = new createjs.Stage("mainCanvas");
    stage.enableMouseOver();

    popupCont = new createjs.Container();
    stage.addChild(popupCont);

    statusText = new createjs.Text("Φόρτωση...", "20px Arial", "white");
    statusText.textAlign = "center";
    statusText.textBaseline = "middle";
    stage.addChild(statusText);
    
    stage.update();
    resize();
    // Resource preloading
    for (var i = 0; i < resourceNames.length; i++) {

      resources[i] = new Image();
      resources[i].src = "resource/" + resourceNames[i];
      resources[i].onload = queueFileLoad;

    }
    // The last queueFileLoad calls queueComplete. Execution continues there.

  }

function imgByName(name) {
  return resources[resourceNames.indexOf(name)];
}

function queueFileLoad(event) {
  resourcesLoaded++;
  statusText.text = "Φόρτωση... " + parseInt(100*resourcesLoaded/resourceNames.length) + " %";
  stage.update();
  if (resourcesLoaded == resourceNames.length)
    queueComplete(event);
}

function queueComplete(event) {
  console.log("Finished loading resources");
  bg = new createjs.Bitmap(imgByName("background.svg"));
  stage.addChild(bg);
  
  buttonOk = new createjs.Bitmap(imgByName("buttonOK.svg"));
  buttonOk.addEventListener('click',function(event){
    var msg = "Χρειάζεται:\n";
    var cnames = {'R':'κόκκινο','Y':'κίτρινο','B':'μπλε'};
    for (i = 0; i<Object.keys(cnames).length; i++){
      var item = Object.keys(cnames)[i];
      if (workingrybs[item]<targetrybs[item]){
        msg += "Περισσότερο " + cnames[item];
      }
      else{
        if (workingrybs[item]>targetrybs[item]){
          msg += "Λιγότερο " + cnames[item]
        }
      }
      msg+="\n";
    }


    if (ryb2hex(workingrybs) != ryb2hex(targetrybs)){
      pu = new popup();
      pu.setTxt(msg);
      pu.show();      
    }
    else{
      success = true;
      imgSuccess.visible = true;
      stage.addChild(imgSuccess);
      setTimeout(onMenuNext,1000);
    }


  });
  buttonOk.addEventListener("mouseover", function(event) {
        // Bring the target on top in its container, mostly for the rotation animation
        event.target.parent.setChildIndex(event.target, event.target.parent.numChildren - 1);
        event.target.scaleX = 1.2*event.target.savedscaleX;
        event.target.scaleY = 1.2*event.target.savedscaleY;
        stage.update();});
  buttonOk.addEventListener("mouseout", function(event) {
        event.target.scaleX = event.target.savedscaleX;
        event.target.scaleY = event.target.savedscaleY;
        stage.update();});

  stage.addChild(buttonOk);
  var onMenuClick = [onMenuHome, onMenuHelp, onMenuAbout, onMenuPrevious, onMenuNext];
  //initialize all 5 together
  //they are resized in two groups in function resize()
  for (i = 0; i < 5; i++) {

    menubar[i] = new createjs.Bitmap(resources[resourceNames.indexOf('bar_home.svg')+i]);
    menubar[i].addEventListener("click", onMenuClick[i]);
    menubar[i].addEventListener("mouseover", function(event) {
        // Bring the target on top in its container, mostly for the rotation animation
        event.target.parent.setChildIndex(event.target, event.target.parent.numChildren - 1);
        event.target.scaleX = 1.2*event.target.savedscaleX;
        event.target.scaleY = 1.2*event.target.savedscaleY;
        stage.update();});
    menubar[i].addEventListener("mouseout", function(event) {
        event.target.scaleX = event.target.savedscaleX;
        event.target.scaleY = event.target.savedscaleY;
        stage.update();});
    stage.addChild(menubar[i]);
    
  }
  lvlText = new createjs.Text("1", "20px Arial", "black");
  lvlText.textAlign = "center";
  lvlText.textBaseline = "middle";
  stage.addChild(lvlText);


  explainText = new createjs.Text("Ταίριαξε τα χρώματα","20px Arial","black");
  explainText.textAlign = "center";
  explainText.textBaseline = "middle";
  stage.addChild(explainText);

  ci = ['B','Y','R'];
  redPlus = new createjs.Bitmap(imgByName('redPlus.svg'));
  redPlus.on('click', function(){
    addWorkingColor('R');
  });
  stage.addChild(redPlus);

  redMinus = new createjs.Bitmap(imgByName('redMinus.svg'));
  redMinus.on('click', function(){
    subWorkingColor('R');
  });
  stage.addChild(redMinus);

  yellowPlus = new createjs.Bitmap(imgByName('yellowPlus.svg'));
  yellowPlus.on('click', function(){
    addWorkingColor('Y');
  });
  stage.addChild(yellowPlus);

  yellowMinus = new createjs.Bitmap(imgByName('yellowMinus.svg'));
  yellowMinus.on('click', function(){
    subWorkingColor('Y');
  });
  stage.addChild(yellowMinus);

  bluePlus = new createjs.Bitmap(imgByName('bluePlus.svg'));
  bluePlus.on('click', function(){
    addWorkingColor('B');
  });
  stage.addChild(bluePlus);

  blueMinus = new createjs.Bitmap(imgByName('blueMinus.svg'));
  blueMinus.on('click', function(){
    subWorkingColor('B');
  });
  stage.addChild(blueMinus);


  popupBkg = new createjs.Bitmap(imgByName('popup.svg'));
  popupTxt = new createjs.Text(this.txt,'20px Arial', 'white');
  popupCont.addChild(popupBkg);


  imgSuccess = new createjs.Bitmap(imgByName('lion_good.svg'));  
  imgSuccess.visible = false;
  stage.update();
  initLevel(0);
  resize();
  window.addEventListener('resize', resize, false);
  createjs.Ticker.on("tick", tick);
}

function getRandomColor(cn,cs){
  //colornum and colorstep
  var t = {};
  maxClicks = Math.floor(100.0/cs);
  var allColors = ['R','Y','B'];
  t['R'] = 0;
  t['Y'] = 0;
  t['B'] = 0;
  while (targetColors.indexOf(ryb2hex(t))>=0){
    t['R'] = 0;
    t['Y'] = 0;
    t['B'] = 0;    
    for (var i=0; i<cn; i++){
      c = Math.floor(Math.random()*allColors.length);
      if (maxClicks !=1){
        t[allColors[c]] = Math.floor(Math.random()*maxClicks)*cs;
      }
      else{//only for first level
        t[allColors[c]] = 100;
      }
      allColors.slice(c,1);
    }
  }
  targetColors.push(ryb2hex(t));
  return(t);
}

function ryb2hex(rybsDict){
  //the black controversy
  if (rybsDict['R']==maxClicks * lvlColorStep 
      && rybsDict['Y']==maxClicks * lvlColorStep 
      && rybsDict['B']==maxClicks * lvlColorStep){
    return('#000000');
  }

  r = rybsDict['R']/100;
  y = rybsDict['Y']/100;
  b = rybsDict['B']/100;
  rgb_red   = getR(r,y,b);
  rgb_green = getG(r,y,b);
  rgb_blue  = getB(r,y,b);
  
  var rStr = Math.floor(rgb_red).toString(16);
    var gStr = Math.floor(rgb_green).toString(16);
    var bStr = Math.floor(rgb_blue).toString(16);
    if (rStr.length == 1){
      rStr = "0"+rStr;
    }
    if (gStr.length == 1){
      gStr = "0"+gStr;
    }
    if (bStr.length == 1){
      bStr = "0"+bStr;
    }
    var retStr = "#" + rStr + gStr + bStr;
    return(retStr);
}
  function cubicInt(t, A, B){
      var weight = t*t*(3-2*t);
      return A + weight*(B-A);
  }

  function getR(iR, iY, iB) {
    // red
    var x0 = cubicInt(iB, 1.0, 0.163);
    var x1 = cubicInt(iB, 1.0, 0.0);
    var x2 = cubicInt(iB, 1.0, 0.5);
    var x3 = cubicInt(iB, 1.0, 0.2);
    var y0 = cubicInt(iY, x0, x1);
    var y1 = cubicInt(iY, x2, x3);
    return Math.ceil (255 * cubicInt(iR, y0, y1));
  }

  function getG(iR, iY, iB) {
    // green
    var x0 = cubicInt(iB, 1.0, 0.373);
    var x1 = cubicInt(iB, 1.0, 0.66);
    var x2 = cubicInt(iB, 0.0, 0.0);
    var x3 = cubicInt(iB, 0.5, 0.094);
    var y0 = cubicInt(iY, x0, x1);
    var y1 = cubicInt(iY, x2, x3);
    return Math.ceil (255 * cubicInt(iR, y0, y1));
  }

  function getB(iR, iY, iB) {
    // blue
    var x0 = cubicInt(iB, 1.0, 0.6);
    var x1 = cubicInt(iB, 0.0, 0.2);
    var x2 = cubicInt(iB, 0.0, 0.5);
    var x3 = cubicInt(iB, 0.0, 0.0);
    var y0 = cubicInt(iY, x0, x1);
    var y1 = cubicInt(iY, x2, x3);
    return Math.ceil (255 * cubicInt(iR, y0, y1));
  }

function addWorkingColor(c){

  if (workingrybs[c] + lvlColorStep <= 100){
    workingrybs[c] += lvlColorStep;
  }
  drawWorkingCircle();
  stage.update();

}

function subWorkingColor(c){
  if (workingrybs[c] - lvlColorStep >= 0){
    workingrybs[c] -= lvlColorStep;
  }
  drawWorkingCircle();
}


function initLevel(newLevel) {
  if (newLevel == 0){
    targetColors = ["#ffffff"];//no color has been played yet
  }
  lvlColorNum = colorNum[newLevel];
  lvlColorStep = colorStep[newLevel];
  targetrybs = getRandomColor(lvlColorNum,lvlColorStep);
  workingrybs = {'R':0,'Y':0,'B':0};
  level = newLevel;
  lvlText.text = level;
  resize();


}
function drawWorkingCircle(){
    workingCircle.graphics.clear();
    workingCircle.graphics.setStrokeStyle(4).beginStroke("lightgray").beginFill(ryb2hex(workingrybs)).drawCircle(stage.canvas.width / 2 + stage.canvas.width / 500,stage.canvas.height * 0.37,radius).endStroke();
    stage.addChild(workingCircle);
    stage.update();
  }
function resize() {
  // Resize the canvas element
  winratio = window.innerWidth/window.innerHeight;
  if (winratio >= ratio) {
    stage.canvas.height = window.innerHeight;
    stage.canvas.width = stage.canvas.height * ratio;
  } else {
    stage.canvas.width = window.innerWidth;
    stage.canvas.height = stage.canvas.width / ratio;
  }
  if (!menubar[0]) {
    statusText.x = stage.canvas.width / 2;
    statusText.y = stage.canvas.height / 2;
    statusText.font = parseInt(stage.canvas.height/10) + "px Arial";
    stage.setChildIndex(statusText,stage.numChildren - 1);
    statusText.visible = true;
    stage.update();
    return;
  }
  else{
    statusText.visible = false;
  }
  bg.scaleX = stage.canvas.width / bg.image.width;
  bg.scaleY = stage.canvas.height / bg.image.height;

  var bbs = stage.canvas.height / 10;  // bar button size
  var bbm = bbs / 5;  // bar button margin
  // TODO: local/global variables, eslint...
  for (i = 0; i < 3; i++) {
    // Leave one space for the level
    if (i < 4)
      j = i;
    else
      j = i + 1;
    menubar[i].scaleX = bbs / menubar[i].image.width;
    menubar[i].scaleY = bbs / menubar[i].image.height;
    menubar[i].regX = menubar[i].image.width / 2;
    menubar[i].regY = menubar[i].image.height / 2;
    menubar[i].x = (j + 1)*bbm + bbs/2 + j*bbs;
    menubar[i].y = stage.canvas.height - bbm - bbs/2;
    // These copies are used to preserve the original scale on mouseover
    menubar[i].savedscaleX = menubar[i].scaleX;
    menubar[i].savedscaleY = menubar[i].scaleY;
  }
  for (i = 3; i < 5; i++) {
    // Leave one space for the level
    if (i < 4)
      j = i;
    else
      j = i + 1;
    menubar[i].scaleX = bbs / menubar[i].image.width;
    menubar[i].scaleY = bbs / menubar[i].image.height;
    menubar[i].regX = menubar[i].image.width / 2;
    menubar[i].regY = menubar[i].image.height / 2;
    menubar[i].x = stage.canvas.width / 2 + (j + 1)*bbm + bbs/2 + j*bbs;
    menubar[i].y = stage.canvas.height - bbm - bbs/2;
    // These copies are used to preserve the original scale on mouseover
    menubar[i].savedscaleX = menubar[i].scaleX;
    menubar[i].savedscaleY = menubar[i].scaleY;
  }


  lvlText.text = level + 1;
  lvlText.x = stage.canvas.width / 2  + bbs/2 + j*bbs
  lvlText.y = stage.canvas.height - bbm - bbs/2;
  lvlText.font = parseInt(2*bbs/2) + "px Arial";

  // If level is single digit, move lvlText and bar_previous a bit left
  if (level + 1 < 10) {
    lvlText.x -= bbs/4;
    menubar[4].x -= bbs/2;
  }


  explainText.x = stage.canvas.width / 4;
  explainText.y = stage.canvas.height / 7;
  explainText.font = parseInt(bbs/2) + "px Arial";

  radius = stage.canvas.height * 0.14;

  
  targetCircle.graphics.clear();
  targetCircle.graphics.beginFill(ryb2hex(targetrybs)).drawCircle(stage.canvas.width / 2,stage.canvas.height/8,radius * 0.7);
  stage.addChild(targetCircle);

  
  redPlus.scaleX = bg.scaleX;
  redPlus.scaleY = bg.scaleY;
  redPlus.x = stage.canvas.width*0.28;
  redPlus.y = stage.canvas.height * 0.35;
  stage.addChild(redPlus);

  redMinus.scaleX = bg.scaleX;
  redMinus.scaleY = bg.scaleY;
  redMinus.x = stage.canvas.width * 0.22;
  redMinus.y = stage.canvas.height * 0.35;
  stage.addChild(redMinus);

  yellowPlus.scaleX = bg.scaleX;
  yellowPlus.scaleY = bg.scaleY;
  yellowPlus.x = stage.canvas.width * 0.48;
  yellowPlus.y = stage.canvas.height * 0.65;
  stage.addChild(yellowPlus);
  
  yellowMinus.scaleX = bg.scaleX;
  yellowMinus.scaleY = bg.scaleY;
  yellowMinus.x = stage.canvas.width * 0.48;
  yellowMinus.y = stage.canvas.height * 0.73;
  stage.addChild(yellowMinus);
  
  bluePlus.scaleX = bg.scaleX;
  bluePlus.scaleY = bg.scaleY;
  bluePlus.x = stage.canvas.width * 0.69;
  bluePlus.y = stage.canvas.height * 0.35;
  stage.addChild(bluePlus);

  blueMinus.scaleX = bg.scaleX;
  blueMinus.scaleY = bg.scaleY;
  blueMinus.x = stage.canvas.width * 0.74;
  blueMinus.y = stage.canvas.height * 0.35;
  stage.addChild(blueMinus);

  stage.update();
  drawWorkingCircle();





  buttonOk.scaleX = menubar[0].scaleX;
  buttonOk.scaleY = menubar[0].scaleY;
  var hit = new createjs.Shape();
  hit.graphics.beginFill("000").drawRect(0,0,buttonOk.image.width,buttonOk.image.height);
  buttonOk.hitArea = hit;
  buttonOk.regX = buttonOk.image.width/2;
  buttonOk.regY = buttonOk.image.height/2;
  buttonOk.x = stage.canvas.width * 3/4;
  buttonOk.y = stage.canvas.height * 2/3;
  buttonOk.savedscaleX = buttonOk.scaleX;
  buttonOk.savedscaleY = buttonOk.scaleY;

  imgSuccess.scaleY = (2/3) * stage.canvas.height / imgSuccess.image.height;
  imgSuccess.scaleX = imgSuccess.scaleY;
  imgSuccess.regX = imgSuccess.image.width / 2;
  imgSuccess.regY = imgSuccess.image.height / 2;
  imgSuccess.x = stage.canvas.width / 2;
  imgSuccess.y = stage.canvas.height / 2;

  //If there is popup resize it
  if (pu){
  pu.resize();
  }
  // Fill all the canvas with the background
  stage.update();
}
function onMenuAbout(event) {
  window.open("credits/index_DS_II.html");
}

function onMenuHelp(event) {
  alert("Χρησιμοποιήστε τα + και τα - και ταιριάξτε τα χρώματα.");
}

function onMenuHome(event) {
  window.history.back();
}

function onMenuPrevious(event) {
  initLevel((level+colorStep.length-1) % colorStep.length);
}

function onMenuNext(event) {
  success = false;
  imgSuccess.visible = false;
  initLevel((level+1) % colorStep.length);
}

function tick(){
  if (success){
    imgSuccess.scaleX *= 1.01;
    imgSuccess.scaleY *= 1.01;
  }
  else{
  }
  stage.update();
  
}
</script>
</body>
</html>